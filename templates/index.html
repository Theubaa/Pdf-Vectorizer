<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>PDF Vectorizer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #0f172a;
            color: #e5e7eb;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .container {
            background: #020617;
            border-radius: 16px;
            padding: 32px 28px;
            max-width: 640px;
            width: 100%;
            box-shadow: 0 24px 60px rgba(15, 23, 42, 0.9);
            border: 1px solid #1e293b;
        }
        h1 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1.6rem;
            color: #f9fafb;
        }
        p.subtitle {
            margin-top: 0;
            margin-bottom: 20px;
            color: #94a3b8;
            font-size: 0.9rem;
        }
        .upload-area {
            border: 1px dashed #334155;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            background: #020617;
        }
        .upload-area input[type="file"] {
            display: none;
        }
        .upload-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border-radius: 999px;
            background: linear-gradient(135deg, #2563eb, #4f46e5);
            color: #f9fafb;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            box-shadow: 0 12px 30px rgba(37, 99, 235, 0.5);
        }
        .file-name {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #cbd5f5;
        }
        button#upload-btn {
            margin-top: 18px;
            width: 100%;
            padding: 10px 16px;
            border-radius: 999px;
            border: none;
            background: #16a34a;
            color: #ecfdf5;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
        }
        button#upload-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .progress-bar {
            margin-top: 18px;
            width: 100%;
            height: 8px;
            background: #020617;
            border-radius: 999px;
            overflow: hidden;
            border: 1px solid #1f2933;
        }
        .progress-inner {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #22c55e, #22d3ee);
            transition: width 0.1s linear;
        }
        .status {
            margin-top: 14px;
            font-size: 0.9rem;
            min-height: 1.2em;
        }
        .status.success {
            color: #4ade80;
        }
        .status.error {
            color: #fca5a5;
        }
        .meta {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #cbd5f5;
        }
        .downloads {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        .downloads button {
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid #1e293b;
            background: #020617;
            color: #e5e7eb;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .downloads .file-id-label {
            font-size: 0.8rem;
            color: #9ca3af;
        }
        .search-section {
            margin-top: 26px;
            padding-top: 18px;
            border-top: 1px solid #1e293b;
        }
        .search-row {
            display: flex;
            gap: 10px;
        }
        .search-row input[type="text"] {
            flex: 1;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #1e293b;
            background: #020617;
            color: #e5e7eb;
            font-size: 0.9rem;
        }
        .search-row button {
            padding: 8px 14px;
            border-radius: 10px;
            border: none;
            background: #2563eb;
            color: #e5e7eb;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .search-results {
            margin-top: 12px;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .result-item {
            padding: 8px 0;
            border-bottom: 1px solid #1f2937;
        }
        .result-file {
            color: #9ca3af;
            font-size: 0.8rem;
        }
        .result-score {
            color: #a5b4fc;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PDF Vectorizer</h1>
        <p class="subtitle">Upload a PDF, JSON, CSV, or Excel file (max 1GB). The server will extract text, build embeddings, and store vectors for search.</p>

        <form id="upload-form">
            <div class="upload-area">
                <label class="upload-label" for="file-input">
                    <span>Select a file</span>
                </label>
                <input id="file-input" type="file" name="file" accept=".pdf,.json,.csv,.xls,.xlsx" />
                <div class="file-name" id="file-name">No file selected</div>
            </div>
            <button type="submit" id="upload-btn" disabled>Upload &amp; Process PDF</button>

            <div class="progress-bar">
                <div class="progress-inner" id="progress-inner"></div>
            </div>

            <div class="status" id="status"></div>
            <div class="meta" id="meta"></div>
            <div class="downloads" id="downloads" style="display: none;">
                <span class="file-id-label" id="file-id-label"></span>
                <button type="button" id="btn-download-text">Download Raw Text</button>
                <button type="button" id="btn-download-chunks">Download Chunks</button>
            </div>
        </form>

        <div class="search-section">
            <div class="search-row">
                <input type="text" id="search-query" placeholder="Semantic search across uploaded PDFs (optional)..." />
                <button type="button" id="search-btn">Search</button>
            </div>
            <div class="search-results" id="search-results"></div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById("file-input");
        const fileNameEl = document.getElementById("file-name");
        const uploadBtn = document.getElementById("upload-btn");
        const progressInner = document.getElementById("progress-inner");
        const statusEl = document.getElementById("status");
        const metaEl = document.getElementById("meta");
        const downloadsEl = document.getElementById("downloads");
        const fileIdLabelEl = document.getElementById("file-id-label");
        const btnDownloadText = document.getElementById("btn-download-text");
        const btnDownloadChunks = document.getElementById("btn-download-chunks");
        const uploadForm = document.getElementById("upload-form");

        const searchInput = document.getElementById("search-query");
        const searchBtn = document.getElementById("search-btn");
        const searchResultsEl = document.getElementById("search-results");

        let currentFileId = null;
        let rawDownloadUrl = null;
        let chunksDownloadUrl = null;

        fileInput.addEventListener("change", () => {
            if (fileInput.files.length > 0) {
                const f = fileInput.files[0];
                fileNameEl.textContent = `${f.name} (${(f.size / (1024 * 1024)).toFixed(2)} MB)`;
                uploadBtn.disabled = false;
            } else {
                fileNameEl.textContent = "No file selected";
                uploadBtn.disabled = true;
            }
        });

        uploadForm.addEventListener("submit", (e) => {
            e.preventDefault();
            if (!fileInput.files.length) return;

            const file = fileInput.files[0];
            const maxSizeBytes = 1024 * 1024 * 1024; // 1GB
            if (file.size > maxSizeBytes) {
                statusEl.textContent = "File exceeds 1GB limit.";
                statusEl.className = "status error";
                return;
            }

            statusEl.textContent = "Uploading...";
            statusEl.className = "status";
            metaEl.textContent = "";
            downloadsEl.style.display = "none";
            currentFileId = null;
            rawDownloadUrl = null;
            chunksDownloadUrl = null;
            progressInner.style.width = "0%";
            uploadBtn.disabled = true;

            const formData = new FormData();
            formData.append("file", file);

            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/upload", true);

            xhr.upload.onprogress = (event) => {
                if (event.lengthComputable) {
                    const percent = (event.loaded / event.total) * 100;
                    progressInner.style.width = `${percent.toFixed(0)}%`;
                }
            };

            xhr.onload = () => {
                uploadBtn.disabled = false;
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        if (data.status === "ok" || data.status === "no_text_found") {
                            statusEl.textContent = data.status === "ok"
                                ? "Upload and processing completed."
                                : "Upload completed, but no text was found in the PDF.";
                            statusEl.className = "status success";
                            metaEl.textContent =
                                `file: ${data.file_name} | pages: ${data.number_of_pages} | chunks: ${data.number_of_chunks}`;

                            if (data.file_id) {
                                currentFileId = data.file_id;
                                fileIdLabelEl.textContent = `file_id: ${data.file_id}`;

                                // Use backend-provided URLs and existence flags when available.
                                rawDownloadUrl = data.raw_download_url || null;
                                chunksDownloadUrl = data.chunks_download_url || null;

                                const rawExists = data.raw_exists === true;
                                const chunksExist = data.chunks_exist === true;

                                btnDownloadText.disabled = !rawExists || !rawDownloadUrl;
                                btnDownloadChunks.disabled = !chunksExist || !chunksDownloadUrl;

                                if (rawExists || chunksExist) {
                                    downloadsEl.style.display = "flex";
                                } else {
                                    downloadsEl.style.display = "none";
                                }
                            }
                        } else {
                            statusEl.textContent = "Unexpected response from server.";
                            statusEl.className = "status error";
                        }
                    } catch (err) {
                        statusEl.textContent = "Failed to parse server response.";
                        statusEl.className = "status error";
                    }
                } else {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        statusEl.textContent = data.detail || "Upload failed.";
                    } catch {
                        statusEl.textContent = "Upload failed.";
                    }
                    statusEl.className = "status error";
                }
            };

            xhr.onerror = () => {
                uploadBtn.disabled = false;
                statusEl.textContent = "Network error during upload.";
                statusEl.className = "status error";
            };

            xhr.send(formData);
        });

        btnDownloadText.addEventListener("click", () => {
            if (!rawDownloadUrl) return;
            console.log("Opening raw download URL:", rawDownloadUrl);
            window.open(rawDownloadUrl, "_blank");
        });

        btnDownloadChunks.addEventListener("click", () => {
            if (!chunksDownloadUrl) return;
            console.log("Opening chunks download URL:", chunksDownloadUrl);
            window.open(chunksDownloadUrl, "_blank");
        });

        searchBtn.addEventListener("click", () => {
            const query = searchInput.value.trim();
            if (!query) return;

            searchResultsEl.textContent = "Searching...";

            fetch("/search", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: new URLSearchParams({ query, top_k: "5" }),
            })
                .then((res) => res.json())
                .then((data) => {
                    if (data.status !== "ok") {
                        if (data.status === "no_index") {
                            searchResultsEl.textContent = "No index available yet. Upload a PDF first.";
                        } else {
                            searchResultsEl.textContent = "Search failed.";
                        }
                        return;
                    }
                    const results = data.results || [];
                    if (!results.length) {
                        searchResultsEl.textContent = "No results.";
                        return;
                    }
                    searchResultsEl.innerHTML = "";
                    results.forEach((item) => {
                        const div = document.createElement("div");
                        div.className = "result-item";
                        div.innerHTML =
                            `<div class="result-file">${item.file_name} (chunk ${item.chunk_index})</div>` +
                            `<div class="result-score">score: ${item.score.toFixed(3)}</div>` +
                            `<div>${item.text}</div>`;
                        searchResultsEl.appendChild(div);
                    });
                })
                .catch(() => {
                    searchResultsEl.textContent = "Search request failed.";
                });
        });
    </script>
</body>
</html>


